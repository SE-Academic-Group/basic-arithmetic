name: Deploy Server

on:
  workflow_dispatch:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

jobs:
  deploy_job:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Setup SSH
      run: |
        apk update && apk add openssh-client bash
        mkdir -p ~/.ssh
        eval $(ssh-agent -s)
        echo "$DROPLET_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
        touch ~/.ssh/config
        echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
        ssh-keyscan -H $DROPLET_PUBLIC_IP >> ~/.ssh/known_hosts

    - name: Deploy to Server
      env:
        DROPLET_USER: ${{ secrets.DROPLET_USER }}
        DROPLET_PUBLIC_IP: ${{ secrets.DROPLET_PUBLIC_IP }}
      run: |
        echo "SSH to server..."
        ssh $DROPLET_USER@$DROPLET_PUBLIC_IP "cd basic-arithmetic/ && git pull && docker compose up --build -d"
        echo "Server deployed successfully!"
        ssh $DROPLET_USER@$DROPLET_PUBLIC_IP "nohup docker system prune -f > /dev/null 2>&1 &"